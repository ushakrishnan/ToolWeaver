# Testing Strategy

**Current Status:** 971/985 tests passing (98.6%) | Coverage: 67.61%

- Unit tests: `pytest` (default markers), fast and deterministic.
- Coverage: gated and uploaded (see below), goal ≥75% for core (ratcheting to 80%).
- Mark slow/integration tests with `@pytest.mark.slow` / `@pytest.mark.integration`.
- Type checks: `mypy` per `pyproject.toml` with strict overrides for key modules.
- Lint: `ruff` per `pyproject.toml`.

## How to Run

- Local run:
	- `pytest -q`
	- `pytest -q -m "not slow and not integration"`
	- View HTML coverage in `htmlcov/index.html` (generated by CI and optionally locally with `--cov-report=html`).

## Coverage Configuration

- Pytest adds opts from `pyproject.toml`:
	- `--cov=orchestrator`
	- `--cov-report=term-missing` (summary)
	- `--cov-report=html` (htmlcov/)
	- `--cov-report=xml` (coverage.xml for Codecov)
	- `--cov-fail-under=75` (gate; ratchet ↑ as we improve)

- Codecov policy in `codecov.yml`:
	- Project target ≈ 75% (threshold 2%)
	- Patch target ≈ 80% (threshold 1%)
	- CI uploads via `codecov/codecov-action@v4`

- Ratchet plan:
	- Add targeted tests for new/changed code
	- Bump pytest gate to 80% and Codecov project target once stable

## Test Reports

**NEW:** Comprehensive test documentation now available:
- [TEST_COVERAGE_REPORT.md](../internal/test-reports/TEST_COVERAGE_REPORT.md) - Module-by-module breakdown (36 modules >90%, 25 modules 70-90%, 29 modules <70%)
- [FAILING_TESTS_ANALYSIS.md](../internal/test-reports/FAILING_TESTS_ANALYSIS.md) - Analysis of 8 failing tests with fix complexity
- [FINAL_STATUS_REPORT.md](../internal/test-reports/FINAL_STATUS_REPORT.md) - Complete test execution summary

## Type Checking

- `mypy orchestrator`
- Strict overrides for:
	- `orchestrator.__init__`
	- `orchestrator._internal.*`
	- `orchestrator.plugins.*`
- Expand strict coverage as modules get fully annotated.

## Example Adapter Tests

- The external MCP adapter example includes an HTTP-mode smoke test that spins up a local `aiohttp` server to validate `discover` and `execute` flows.
- WebSocket-mode tests can be added later using an in-process echo server fixture.

## Markers

- `@pytest.mark.unit` – default
- `@pytest.mark.slow` – long-running
- `@pytest.mark.integration` – real service dependencies

## CI Summary

- Lint `ruff`, type-check `mypy`, test `pytest` with coverage and gates.
- Upload coverage to Codecov.
- Public API smoke job: install `--no-deps`, import `orchestrator`, run `validate_config()` without optional deps.
- Dispatch suite: run `tests/test_sub_agent_dispatch.py` in the matrix to cover parallel dispatch limits/aggregation and logging redaction.
	- Secrets redactor auto-installs on import. If a test needs to assert raw logs, remove the filter via `from orchestrator._internal.security.secrets_redactor import remove_secrets_redactor; remove_secrets_redactor()` and restore after.


## Coverage Configuration

- Pytest adds opts from `pyproject.toml`:
	- `--cov=orchestrator`
	- `--cov-report=term-missing` (summary)
	- `--cov-report=html` (htmlcov/)
	- `--cov-report=xml` (coverage.xml for Codecov)
	- `--cov-fail-under=75` (gate; ratchet ↑ as we improve)

- Codecov policy in `codecov.yml`:
	- Project target ≈ 75% (threshold 2%)
	- Patch target ≈ 80% (threshold 1%)
	- CI uploads via `codecov/codecov-action@v4`

- Ratchet plan:
	- Add targeted tests for new/changed code
	- Bump pytest gate to 80% and Codecov project target once stable

## Type Checking

- `mypy orchestrator`
- Strict overrides for:
	- `orchestrator.__init__`
	- `orchestrator._internal.*`
	- `orchestrator.plugins.*`
- Expand strict coverage as modules get fully annotated.

## Example Adapter Tests

- The external MCP adapter example includes an HTTP-mode smoke test that spins up a local `aiohttp` server to validate `discover` and `execute` flows.
- WebSocket-mode tests can be added later using an in-process echo server fixture.

## Markers

- `@pytest.mark.unit` – default
- `@pytest.mark.slow` – long-running
- `@pytest.mark.integration` – real service dependencies

## CI Summary

- Lint `ruff`, type-check `mypy`, test `pytest` with coverage and gates.
- Upload coverage to Codecov.
- Public API smoke job: install `--no-deps`, import `orchestrator`, run `validate_config()` without optional deps.
- Dispatch suite: run `tests/test_sub_agent_dispatch.py` in the matrix to cover parallel dispatch limits/aggregation and logging redaction.
	- Secrets redactor auto-installs on import. If a test needs to assert raw logs, remove the filter via `from orchestrator._internal.security.secrets_redactor import remove_secrets_redactor; remove_secrets_redactor()` and restore after.
