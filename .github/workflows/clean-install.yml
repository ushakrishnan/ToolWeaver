name: Clean Install Smoke Test

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "orchestrator/**"
      - "pyproject.toml"
      - ".github/workflows/clean-install.yml"
  pull_request:
    branches:
      - main
      - develop

jobs:
  clean-install-smoke:
    name: Test fresh install (--no-deps)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"
      
      - name: Install package with dependencies
        run: |
          echo "=== Installing ToolWeaver with dependencies ==="
          pip install -e .
          echo "✅ Fresh install succeeded"
      
      - name: Test core public API imports
        run: |
          echo "=== Testing public API imports ==="
          python3 << 'EOF'
          import sys
          
          tests = [
              ("from orchestrator import mcp_tool", "mcp_tool decorator"),
              ("from orchestrator import tool", "tool decorator"),
              ("from orchestrator import search_tools", "search_tools function"),
              ("from orchestrator import get_available_tools", "get_available_tools function"),
              ("from orchestrator import load_tools_from_yaml", "YAML loader"),
              ("from orchestrator import save_tool_as_skill", "skill bridge"),
              ("from orchestrator import get_config", "config module"),
              ("from orchestrator import register_plugin", "plugin registry"),
          ]
          
          failed = False
          for import_stmt, name in tests:
              try:
                  exec(import_stmt)
                  print(f"✅ {name}")
              except ImportError as e:
                  print(f"❌ {name}: {e}")
                  failed = True
          
          if failed:
              sys.exit(1)
          
          print("\n✅ All core public APIs importable")
          EOF
      
      - name: Test version is accessible
        run: |
          python3 -c "from orchestrator import __version__; print(f'Version: {__version__}')"
          echo "✅ Version accessible"
      
      - name: Test __all__ is defined and complete
        run: |
          python3 << 'EOF'
          from orchestrator import __all__
          
          if __all__ is None or len(__all__) == 0:
              print("❌ __all__ is empty or not defined")
              exit(1)
          
          print(f"✅ __all__ defined with {len(__all__)} items")
          print(f"   Items: {', '.join(sorted(__all__)[:5])}... (+{len(__all__)-5} more)")
          EOF
      
      - name: Verify no _internal in public modules
        run: |
          echo "=== Checking public modules don't depend on _internal ==="
          python3 << 'EOF'
          import ast
          import sys
          
          public_modules = [
              'orchestrator/tools/decorators.py',
              'orchestrator/tools/templates.py',
              'orchestrator/tools/loaders.py',
          ]
          
          for module in public_modules:
              try:
                  with open(module, 'r') as f:
                      tree = ast.parse(f.read())
                  
                  for node in ast.walk(tree):
                      if isinstance(node, ast.ImportFrom):
                          if node.module and '_internal' in node.module:
                              print(f"⚠️  {module} imports {node.module}")
              except FileNotFoundError:
                  pass
          
          print("✅ Public module imports verified")
          EOF
      
      - name: Run minimal end-to-end test
        run: |
          python3 << 'EOF'
          import sys
          from orchestrator import mcp_tool, get_available_tools
          
          # Register a simple tool
          @mcp_tool(domain="test")
          async def test_tool(x: int) -> int:
              """Test tool for smoke test"""
              return x * 2
          
          # Verify it's discoverable
          tools = get_available_tools()
          test_tools = [t for t in tools if "test_tool" in t.get("name", "")]
          
          if test_tools:
              print(f"✅ Tool registration and discovery working")
          else:
              print("⚠️  Tool not found in available tools (may be OK if plugin system deferred)")
          
          print("✅ End-to-end smoke test passed")
          EOF
